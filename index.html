<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSG — Document Processing</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%231a1a1a'/%3E%3Ctext x='16' y='20' text-anchor='middle' font-family='Georgia' font-size='12' fill='%23e8e4df'%3EOSG%3C/text%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      /* The palette of luminous emptiness */
      --void: #0f0f0f;
      --deep: #1a1a1a;
      --surface: #faf9f7;
      --surface-warm: #f5f3ef;
      --surface-glow: #fffef9;
      --ink: #1a1a1a;
      --ink-soft: #4a4a4a;
      --ink-muted: #8a8a8a;
      --ink-ghost: #c5c5c5;
      
      /* The accent — warm teal, like deep water catching light */
      --light: #2d8a8a;
      --light-soft: #3a9e9e;
      --light-glow: rgba(45, 138, 138, 0.08);
      --light-ring: rgba(45, 138, 138, 0.15);
      
      /* States */
      --complete: #5a9a6a;
      --complete-soft: rgba(90, 154, 106, 0.1);
      --warning: #c4956a;
      --warning-soft: rgba(196, 149, 106, 0.1);
      --error: #b86a6a;
      --error-soft: rgba(184, 106, 106, 0.1);
      
      /* Typography */
      --font-display: 'Cormorant Garamond', Georgia, serif;
      --font-body: 'DM Sans', -apple-system, sans-serif;
      
      /* Spacing — generous, breathing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 40px;
      --space-2xl: 64px;
      --space-3xl: 96px;
      
      /* Shadows — soft, ambient */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
      --shadow-glow: 0 0 40px rgba(45, 138, 138, 0.1);
      
      /* Transitions — smooth, unhurried */
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-in-out: cubic-bezier(0.65, 0, 0.35, 1);
      --duration-fast: 150ms;
      --duration-normal: 300ms;
      --duration-slow: 500ms;
      
      /* Border radius — soft, organic */
      --radius-sm: 6px;
      --radius-md: 12px;
      --radius-lg: 20px;
      --radius-xl: 32px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      font-family: var(--font-body);
      background: var(--surface);
      color: var(--ink);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* === LOADING STATE === */
    .loading-screen {
      position: fixed;
      inset: 0;
      background: var(--surface);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity var(--duration-slow) var(--ease-out);
    }
    
    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-mark {
      font-family: var(--font-display);
      font-size: 2rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      color: var(--ink);
      margin-bottom: var(--space-lg);
      animation: breathe 2s var(--ease-in-out) infinite;
    }
    
    .loading-text {
      font-size: 0.875rem;
      color: var(--ink-muted);
      letter-spacing: 0.02em;
    }
    
    @keyframes breathe {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }
    
    /* === MAIN LAYOUT === */
    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
      opacity: 0;
      animation: fadeIn var(--duration-slow) var(--ease-out) forwards;
      animation-delay: 200ms;
    }
    
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    
    /* === SIDEBAR === */
    .sidebar {
      background: var(--surface-warm);
      border-right: 1px solid rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: sticky;
      top: 0;
    }
    
    .sidebar-header {
      padding: var(--space-xl) var(--space-lg);
      border-bottom: 1px solid rgba(0,0,0,0.04);
    }
    
    .brand {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    .brand-mark {
      width: 40px;
      height: 40px;
      background: var(--void);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-display);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--surface);
      letter-spacing: 0.05em;
    }
    
    .brand-text {
      flex: 1;
    }
    
    .brand-name {
      font-family: var(--font-display);
      font-size: 1.125rem;
      font-weight: 500;
      color: var(--ink);
    }
    
    .brand-status {
      font-size: 0.75rem;
      color: var(--ink-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }
    
    .status-indicator {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--complete);
      animation: pulse 2s var(--ease-in-out) infinite;
    }
    
    .status-indicator.disconnected {
      background: var(--error);
      animation: none;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Search */
    .sidebar-search {
      padding: var(--space-lg);
    }
    
    .search-input {
      width: 100%;
      padding: var(--space-md) var(--space-lg);
      background: var(--surface);
      border: 1px solid transparent;
      border-radius: var(--radius-lg);
      font-family: var(--font-body);
      font-size: 0.875rem;
      color: var(--ink);
      transition: all var(--duration-fast) var(--ease-out);
    }
    
    .search-input::placeholder {
      color: var(--ink-ghost);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--light);
      box-shadow: 0 0 0 3px var(--light-ring);
    }
    
    /* Collections */
    .sidebar-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding: 0 var(--space-md);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-sm) var(--space-sm);
      margin-bottom: var(--space-sm);
    }
    
    .section-title {
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--ink-muted);
    }
    
    .section-action {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: var(--ink-muted);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--duration-fast) var(--ease-out);
    }
    
    .section-action:hover {
      background: var(--surface);
      color: var(--ink);
    }
    
    .collections-list {
      flex: 1;
      overflow-y: auto;
      padding-bottom: var(--space-lg);
    }
    
    .collections-list::-webkit-scrollbar {
      width: 4px;
    }
    
    .collections-list::-webkit-scrollbar-thumb {
      background: var(--ink-ghost);
      border-radius: 2px;
    }
    
    .collection-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-md);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      position: relative;
      margin-bottom: 2px;
    }
    
    .collection-item:hover {
      background: var(--surface);
    }
    
    .collection-item.active {
      background: var(--surface-glow);
      box-shadow: var(--shadow-sm);
    }
    
    .collection-item.complete {
      opacity: 0.6;
    }
    
    .collection-item.complete:hover {
      opacity: 1;
    }
    
    .collection-icon {
      width: 32px;
      height: 32px;
      background: var(--light-glow);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--light);
      flex-shrink: 0;
      transition: all var(--duration-fast) var(--ease-out);
    }
    
    .collection-item.complete .collection-icon {
      background: var(--complete-soft);
      color: var(--complete);
    }
    
    .collection-item.active .collection-icon {
      background: var(--light);
      color: white;
    }
    
    .collection-info {
      flex: 1;
      min-width: 0;
    }
    
    .collection-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .collection-meta {
      font-size: 0.75rem;
      color: var(--ink-muted);
      margin-top: 2px;
    }
    
    .collection-actions {
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity var(--duration-fast) var(--ease-out);
    }
    
    .collection-item:hover .collection-actions {
      opacity: 1;
    }
    
    .collection-action {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: var(--ink-muted);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--duration-fast) var(--ease-out);
    }
    
    .collection-action:hover {
      background: rgba(0,0,0,0.05);
      color: var(--ink);
    }
    
    .collection-action.pinned {
      color: var(--warning);
      opacity: 1;
    }
    
    /* New Collection Button */
    .new-collection {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      border: 1px dashed var(--ink-ghost);
      background: transparent;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      margin-top: var(--space-sm);
      color: var(--ink-muted);
      font-family: var(--font-body);
      font-size: 0.875rem;
      width: 100%;
    }
    
    .new-collection:hover {
      border-color: var(--light);
      color: var(--light);
      background: var(--light-glow);
    }
    
    /* === MAIN CONTENT === */
    .main {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    /* Main Header */
    .main-header {
      padding: var(--space-xl) var(--space-2xl);
      border-bottom: 1px solid rgba(0,0,0,0.04);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .main-title {
      font-family: var(--font-display);
      font-size: 1.75rem;
      font-weight: 400;
      color: var(--ink);
    }
    
    .main-title-empty {
      color: var(--ink-muted);
      font-style: italic;
    }
    
    .main-actions {
      display: flex;
      gap: var(--space-md);
    }
    
    .btn {
      padding: var(--space-sm) var(--space-lg);
      border-radius: var(--radius-lg);
      font-family: var(--font-body);
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      transition: all var(--duration-fast) var(--ease-out);
      border: none;
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--ink-soft);
    }
    
    .btn-ghost:hover {
      background: rgba(0,0,0,0.04);
      color: var(--ink);
    }
    
    .btn-primary {
      background: var(--light);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--light-soft);
      box-shadow: var(--shadow-glow);
    }
    
    /* Main Body */
    .main-body {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 0;
    }
    
    /* Content Area */
    .content-area {
      padding: var(--space-2xl);
      overflow-y: auto;
    }
    
    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      text-align: center;
      color: var(--ink-muted);
    }
    
    .empty-icon {
      width: 80px;
      height: 80px;
      background: var(--surface-warm);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: var(--space-xl);
      color: var(--ink-ghost);
    }
    
    .empty-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 400;
      color: var(--ink-soft);
      margin-bottom: var(--space-sm);
    }
    
    .empty-text {
      font-size: 0.875rem;
      max-width: 280px;
      line-height: 1.6;
    }
    
    /* Checklist Content */
    .checklist {
      max-width: 720px;
      animation: slideUp var(--duration-normal) var(--ease-out);
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .checklist h1 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--ink);
      margin-bottom: var(--space-xl);
      padding-bottom: var(--space-md);
      border-bottom: 2px solid var(--light);
    }
    
    .checklist h2 {
      font-family: var(--font-display);
      font-size: 1.125rem;
      font-weight: 500;
      color: var(--ink);
      margin: var(--space-xl) 0 var(--space-md);
      padding-left: var(--space-md);
      border-left: 3px solid var(--light-glow);
    }
    
    .checklist p {
      font-size: 0.9375rem;
      line-height: 1.7;
      color: var(--ink-soft);
      margin-bottom: var(--space-md);
    }
    
    .checklist ul, .checklist ol {
      margin: var(--space-md) 0;
      padding-left: var(--space-xl);
    }
    
    .checklist li {
      font-size: 0.9375rem;
      line-height: 1.7;
      color: var(--ink-soft);
      margin-bottom: var(--space-sm);
    }
    
    .checklist table {
      width: 100%;
      border-collapse: collapse;
      margin: var(--space-lg) 0;
      font-size: 0.875rem;
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    
    .checklist th {
      background: var(--deep);
      color: var(--surface);
      padding: var(--space-md) var(--space-lg);
      text-align: left;
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .checklist td {
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid rgba(0,0,0,0.04);
      color: var(--ink-soft);
    }
    
    .checklist tr:last-child td {
      border-bottom: none;
    }
    
    .checklist tr:nth-child(even) {
      background: var(--surface-warm);
    }
    
    .checklist td.status-complete {
      color: var(--complete);
      font-weight: 500;
    }
    
    .checklist td.status-incomplete {
      color: var(--error);
    }
    
    .checklist td.status-partial {
      color: var(--warning);
    }
    
    /* Loading State */
    .loading-content {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      color: var(--ink-muted);
      gap: var(--space-md);
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--ink-ghost);
      border-top-color: var(--light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* === UPLOAD PANEL === */
    .upload-panel {
      background: var(--surface-warm);
      border-left: 1px solid rgba(0,0,0,0.04);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 81px);
      position: sticky;
      top: 81px;
    }
    
    .panel-header {
      padding: var(--space-lg) var(--space-xl);
      border-bottom: 1px solid rgba(0,0,0,0.04);
    }
    
    .panel-title {
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 500;
      color: var(--ink);
    }
    
    .panel-body {
      flex: 1;
      padding: var(--space-xl);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    /* Upload Zone */
    .upload-zone {
      border: 2px dashed var(--ink-ghost);
      border-radius: var(--radius-lg);
      padding: var(--space-2xl) var(--space-xl);
      text-align: center;
      cursor: pointer;
      transition: all var(--duration-normal) var(--ease-out);
      background: var(--surface);
      margin-bottom: var(--space-lg);
    }
    
    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--light);
      background: var(--light-glow);
    }
    
    .upload-zone.dragover {
      transform: scale(1.02);
    }
    
    .upload-icon {
      width: 48px;
      height: 48px;
      background: var(--light-glow);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--space-lg);
      color: var(--light);
      transition: all var(--duration-normal) var(--ease-out);
    }
    
    .upload-zone:hover .upload-icon {
      background: var(--light);
      color: white;
      transform: translateY(-4px);
    }
    
    .upload-text {
      font-size: 0.875rem;
      color: var(--ink);
      margin-bottom: var(--space-xs);
    }
    
    .upload-hint {
      font-size: 0.75rem;
      color: var(--ink-muted);
    }
    
    .upload-zone input {
      display: none;
    }
    
    /* Upload Target */
    .upload-target {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-lg);
      background: var(--surface);
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      margin-bottom: var(--space-lg);
    }
    
    .upload-target-label {
      color: var(--ink-muted);
    }
    
    .upload-target-name {
      color: var(--light);
      font-weight: 500;
    }
    
    .upload-target.no-collection .upload-target-name {
      color: var(--warning);
    }
    
    /* Upload Queue */
    .upload-queue {
      margin-bottom: var(--space-lg);
    }
    
    .queue-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      background: var(--surface);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
      animation: slideIn var(--duration-fast) var(--ease-out);
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .queue-icon {
      width: 32px;
      height: 32px;
      background: var(--light-glow);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--light);
      flex-shrink: 0;
    }
    
    .queue-info {
      flex: 1;
      min-width: 0;
    }
    
    .queue-name {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .queue-status {
      font-size: 0.6875rem;
      color: var(--ink-muted);
      margin-top: 2px;
    }
    
    .queue-status.processing { color: var(--light); }
    .queue-status.complete { color: var(--complete); }
    .queue-status.error { color: var(--error); }
    
    .queue-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--ink-ghost);
      border-top-color: var(--light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }
    
    .queue-check {
      color: var(--complete);
      flex-shrink: 0;
    }
    
    /* Library */
    .library {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      border-top: 1px solid rgba(0,0,0,0.04);
      padding-top: var(--space-lg);
    }
    
    .library-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-md);
    }
    
    .library-title {
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--ink-muted);
    }
    
    .library-actions {
      display: flex;
      gap: var(--space-sm);
    }
    
    .library-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: var(--surface);
      color: var(--ink-muted);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--duration-fast) var(--ease-out);
    }
    
    .library-btn:hover:not(:disabled) {
      color: var(--light);
    }
    
    .library-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .library-list {
      flex: 1;
      overflow-y: auto;
    }
    
    .library-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
    }
    
    .library-item:hover {
      background: var(--surface);
    }
    
    .library-item-icon {
      width: 28px;
      height: 28px;
      background: var(--light-glow);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--light);
      flex-shrink: 0;
    }
    
    .library-item-info {
      flex: 1;
      min-width: 0;
    }
    
    .library-item-name {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .library-item-meta {
      font-size: 0.6875rem;
      color: var(--ink-muted);
    }
    
    .library-item.processing {
      opacity: 0.5;
      cursor: default;
    }
    
    .library-item.processing:hover {
      background: transparent;
    }
    
    .library-item-delete {
      width: 20px;
      height: 20px;
      border: none;
      background: transparent;
      color: var(--ink-ghost);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all var(--duration-fast) var(--ease-out);
      flex-shrink: 0;
    }
    
    .library-item:hover .library-item-delete {
      opacity: 1;
    }
    
    .library-item-delete:hover {
      color: var(--error);
      background: var(--error-soft);
    }
    
    .library-empty {
      text-align: center;
      padding: var(--space-xl);
      color: var(--ink-muted);
      font-size: 0.8125rem;
    }
    
    /* === DIALOGS === */
    dialog {
      border: none;
      border-radius: var(--radius-lg);
      padding: 0;
      box-shadow: var(--shadow-lg);
      max-width: 90vw;
      max-height: 85vh;
      overflow: hidden;
    }
    
    dialog::backdrop {
      background: rgba(15, 15, 15, 0.6);
      backdrop-filter: blur(4px);
    }
    
    /* Document Viewer */
    #docViewer {
      width: min(800px, 90vw);
      height: min(80vh, 700px);
      display: flex;
      flex-direction: column;
    }
    
    .viewer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg) var(--space-xl);
      background: var(--deep);
      color: var(--surface);
    }
    
    .viewer-title {
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      margin-right: var(--space-lg);
    }
    
    .viewer-close {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(255,255,255,0.1);
      color: var(--surface);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--duration-fast) var(--ease-out);
    }
    
    .viewer-close:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .viewer-body {
      flex: 1;
      padding: var(--space-xl) var(--space-2xl);
      overflow-y: auto;
      font-size: 0.9375rem;
      line-height: 1.7;
    }
    
    .viewer-body h1 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--ink);
      margin: var(--space-xl) 0 var(--space-lg);
      border-bottom: 2px solid var(--light);
      padding-bottom: var(--space-md);
    }
    
    .viewer-body h1:first-child { margin-top: 0; }
    
    .viewer-body h2 {
      font-family: var(--font-display);
      font-size: 1.125rem;
      font-weight: 500;
      margin: var(--space-xl) 0 var(--space-md);
      border-left: 3px solid var(--light);
      padding-left: var(--space-md);
    }
    
    .viewer-body p { margin-bottom: var(--space-md); color: var(--ink-soft); }
    .viewer-body ul, .viewer-body ol { margin: var(--space-md) 0; padding-left: var(--space-xl); }
    .viewer-body li { margin-bottom: var(--space-sm); color: var(--ink-soft); }
    
    .viewer-body table {
      width: 100%;
      border-collapse: collapse;
      margin: var(--space-lg) 0;
      font-size: 0.875rem;
    }
    
    .viewer-body th {
      background: var(--deep);
      color: var(--surface);
      padding: var(--space-md) var(--space-lg);
      text-align: left;
      font-weight: 500;
    }
    
    .viewer-body td {
      padding: var(--space-md) var(--space-lg);
      border: 1px solid rgba(0,0,0,0.06);
    }
    
    .viewer-body tr:nth-child(even) { background: var(--surface-warm); }
    
    /* Document Picker */
    #docPicker {
      width: min(560px, 90vw);
      height: min(500px, 70vh);
      display: flex;
      flex-direction: column;
    }
    
    .picker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg) var(--space-xl);
      background: var(--deep);
      color: var(--surface);
    }
    
    .picker-title {
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 500;
    }
    
    .picker-search {
      padding: var(--space-lg);
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    
    .picker-search input {
      width: 100%;
      padding: var(--space-md) var(--space-lg);
      border: 1px solid transparent;
      border-radius: var(--radius-lg);
      background: var(--surface-warm);
      font-family: var(--font-body);
      font-size: 0.875rem;
    }
    
    .picker-search input:focus {
      outline: none;
      border-color: var(--light);
      background: var(--surface);
    }
    
    .picker-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-md);
    }
    
    .picker-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      transition: background var(--duration-fast) var(--ease-out);
    }
    
    .picker-item:hover {
      background: var(--surface-warm);
    }
    
    .picker-item-icon {
      width: 32px;
      height: 32px;
      background: var(--light-glow);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--light);
      flex-shrink: 0;
    }
    
    .picker-item-info {
      flex: 1;
      min-width: 0;
    }
    
    .picker-item-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .picker-item-meta {
      font-size: 0.75rem;
      color: var(--ink-muted);
    }
    
    .picker-add-btn {
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--light);
      border-radius: var(--radius-md);
      background: transparent;
      color: var(--light);
      font-family: var(--font-body);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
    }
    
    .picker-add-btn:hover {
      background: var(--light);
      color: white;
    }
    
    .picker-added {
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      background: var(--complete-soft);
      color: var(--complete);
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .picker-empty {
      text-align: center;
      padding: var(--space-2xl);
      color: var(--ink-muted);
      font-size: 0.875rem;
    }
    
    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--surface-glow);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      min-width: 160px;
      z-index: 1000;
      display: none;
      overflow: hidden;
    }
    
    .context-menu.open {
      display: block;
      animation: menuIn var(--duration-fast) var(--ease-out);
    }
    
    @keyframes menuIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .context-item {
      padding: var(--space-md) var(--space-lg);
      font-size: 0.8125rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--space-md);
      color: var(--ink);
      transition: background var(--duration-fast) var(--ease-out);
    }
    
    .context-item:hover {
      background: var(--surface-warm);
    }
    
    .context-item.danger {
      color: var(--error);
    }
    
    .context-item.danger:hover {
      background: var(--error-soft);
    }
    
    .context-item svg {
      width: 14px;
      height: 14px;
    }
    
    /* Toast */
    .toast-container {
      position: fixed;
      bottom: var(--space-xl);
      right: var(--space-xl);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }
    
    .toast {
      background: var(--deep);
      color: var(--surface);
      padding: var(--space-md) var(--space-xl);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: var(--space-md);
      font-size: 0.875rem;
      animation: toastIn var(--duration-normal) var(--ease-out);
    }
    
    .toast.success { background: var(--complete); }
    .toast.error { background: var(--error); }
    
    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* === RESPONSIVE === */
    @media (max-width: 1024px) {
      .app {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        display: none;
      }
      
      .main-body {
        grid-template-columns: 1fr;
      }
      
      .upload-panel {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-mark">OSG</div>
    <div class="loading-text">Connecting...</div>
  </div>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="brand">
          <div class="brand-mark">OSG</div>
          <div class="brand-text">
            <div class="brand-name">Document Processing</div>
            <div class="brand-status">
              <span class="status-indicator" id="statusIndicator"></span>
              <span id="statusText">Connected</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sidebar-search">
        <input type="text" class="search-input" placeholder="Search collections..." id="collectionSearch" oninput="renderCollections()">
      </div>
      
      <div class="sidebar-section">
        <div class="section-header">
          <span class="section-title">Collections</span>
          <button class="section-action" onclick="createCollection()" title="New collection">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
          </button>
        </div>
        
        <div class="collections-list" id="collectionsList">
          <!-- Populated by JS -->
        </div>
        
        <button class="new-collection" onclick="createCollection()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          New Collection
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <header class="main-header">
        <h1 class="main-title" id="mainTitle">
          <span class="main-title-empty">Select a collection</span>
        </h1>
        <div class="main-actions">
          <button class="btn btn-ghost" onclick="refreshData()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </svg>
            Refresh
          </button>
        </div>
      </header>
      
      <div class="main-body">
        <div class="content-area" id="contentArea">
          <div class="empty-state">
            <div class="empty-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
              </svg>
            </div>
            <h2 class="empty-title">No collection selected</h2>
            <p class="empty-text">Select a collection from the sidebar to view its checklist and documents.</p>
          </div>
        </div>
        
        <div class="upload-panel">
          <div class="panel-header">
            <h3 class="panel-title">Upload</h3>
          </div>
          <div class="panel-body">
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
              <div class="upload-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
              </div>
              <p class="upload-text">Drop files here</p>
              <p class="upload-hint">PDF, DOCX, TXT, Images</p>
              <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.txt,.png,.jpg,.jpeg,.xlsx,.xls,.csv,.md">
            </div>
            
            <div class="upload-target" id="uploadTarget">
              <span class="upload-target-label">Uploading to:</span>
              <span class="upload-target-name" id="uploadTargetName">New Collection</span>
            </div>
            
            <div class="upload-queue" id="uploadQueue"></div>
            
            <div class="library">
              <div class="library-header">
                <span class="library-title" id="libraryTitle">Documents</span>
                <div class="library-actions">
                  <button class="library-btn" id="libraryAddBtn" onclick="openDocumentPicker()" title="Add existing" disabled>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="library-list" id="libraryList">
                <div class="library-empty">Select a collection</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu">
    <div class="context-item" onclick="renameCollection()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
      Rename
    </div>
    <div class="context-item" onclick="toggleCompleteCollection()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      <span id="completeMenuText">Mark Complete</span>
    </div>
    <div class="context-item danger" onclick="deleteCollection()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="3 6 5 6 21 6"/>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
      </svg>
      Delete
    </div>
  </div>

  <!-- Document Viewer Dialog -->
  <dialog id="docViewer">
    <div class="viewer-header">
      <span class="viewer-title" id="viewerTitle">Document</span>
      <button class="viewer-close" onclick="closeViewer()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="viewer-body" id="viewerBody"></div>
  </dialog>

  <!-- Document Picker Dialog -->
  <dialog id="docPicker">
    <div class="picker-header">
      <span class="picker-title">Add Documents</span>
      <button class="viewer-close" onclick="closeDocumentPicker()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="picker-search">
      <input type="text" placeholder="Search documents..." id="pickerSearch" oninput="renderDocumentPicker()">
    </div>
    <div class="picker-body" id="pickerBody"></div>
  </dialog>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

<script>
// ===== CONFIG =====
const CONFIG = {
  API_BASE: 'https://api.vertesia.io/api/v1',
  AUTH_BASE: 'https://api.vertesia.io',
  API_KEY: 'sk-cf3c2d29bc38bfee2ae95bf107cb9046',
  INTERACTION: 'PathB'
};

// ===== STATE =====
let jwtToken = null;
let tokenExpiry = null;
let collections = [];
let allDocuments = [];
let selectedCollection = null;
let collectionMembers = {};
let menuTargetCollection = null;

// Persisted state
const PINNED_KEY = 'osg_pinned_collections';
const COMPLETE_KEY = 'osg_complete_collections';
let pinnedCollections = new Set(JSON.parse(localStorage.getItem(PINNED_KEY) || '[]'));
let completedCollections = new Set(JSON.parse(localStorage.getItem(COMPLETE_KEY) || '[]'));

function savePinned() { localStorage.setItem(PINNED_KEY, JSON.stringify([...pinnedCollections])); }
function saveCompleted() { localStorage.setItem(COMPLETE_KEY, JSON.stringify([...completedCollections])); }

// ===== API =====
async function getAuthToken() {
  if (jwtToken && tokenExpiry && Date.now() < tokenExpiry) return jwtToken;
  
  const res = await fetch(`${CONFIG.AUTH_BASE}/auth/token?token=${CONFIG.API_KEY}`, {
    headers: { 'Authorization': `Bearer ${CONFIG.API_KEY}` }
  });
  
  if (!res.ok) throw new Error(`Auth failed: ${res.status}`);
  const data = await res.json();
  jwtToken = data.token;
  tokenExpiry = Date.now() + 50 * 60 * 1000;
  return jwtToken;
}

async function api(endpoint, options = {}) {
  const res = await fetch(`${CONFIG.API_BASE}${endpoint}`, {
    headers: { 'Authorization': `Bearer ${CONFIG.API_KEY}`, 'Content-Type': 'application/json', ...options.headers },
    ...options
  });
  if (!res.ok) throw new Error(`API ${res.status}`);
  if (res.status === 204) return null;
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

async function apiAuth(endpoint, options = {}) {
  const token = await getAuthToken();
  const res = await fetch(`${CONFIG.API_BASE}${endpoint}`, {
    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', ...options.headers },
    ...options
  });
  if (!res.ok) throw new Error(`API ${res.status}`);
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', async () => {
  setupDragDrop();
  setupFileInput();
  setupClickOutside();
  
  try {
    await loadCollections();
    await loadDocuments();
    setStatus(true);
    renderCollections();
  } catch (err) {
    console.error('Init failed:', err);
    setStatus(false);
    showToast('Failed to connect', 'error');
  }
  
  setTimeout(() => {
    document.getElementById('loadingScreen').classList.add('hidden');
  }, 600);
});

function setStatus(ok) {
  document.getElementById('statusIndicator').classList.toggle('disconnected', !ok);
  document.getElementById('statusText').textContent = ok ? 'Connected' : 'Offline';
}

// ===== DATA LOADING =====
async function loadCollections() {
  const data = await api('/collections/search', {
    method: 'POST',
    body: JSON.stringify({ dynamic: false, status: 'active', limit: 100 })
  });
  collections = data || [];
}

async function loadDocuments() {
  const data = await api('/objects?limit=1000&offset=0');
  allDocuments = (Array.isArray(data) ? data : data?.objects || [])
    .filter(o => o.content?.source)
    .map(o => ({
      id: o.id,
      name: o.name || 'Untitled',
      type: o.properties?.document_type || 'Document',
      date: formatDate(o.created_at),
      source: o.content?.source
    }));
}

async function loadCollectionMembers(colId) {
  if (collectionMembers[colId]) return collectionMembers[colId];
  const members = await api(`/collections/${colId}/members?limit=1000`);
  collectionMembers[colId] = (members || []).map(m => m.id || m);
  return collectionMembers[colId];
}

function formatDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

async function refreshData() {
  showToast('Refreshing...');
  collectionMembers = {};
  await loadCollections();
  await loadDocuments();
  renderCollections();
  if (selectedCollection) {
    await selectCollection(selectedCollection.id);
  }
  showToast('Updated', 'success');
}

// ===== RENDERING =====
function renderCollections() {
  const container = document.getElementById('collectionsList');
  const search = document.getElementById('collectionSearch').value.toLowerCase();
  
  let filtered = collections.filter(c => {
    if (!search) return true;
    return c.name.toLowerCase().includes(search);
  });
  
  const sorted = [...filtered].sort((a, b) => {
    const aPinned = pinnedCollections.has(a.id);
    const bPinned = pinnedCollections.has(b.id);
    const aComplete = completedCollections.has(a.id);
    const bComplete = completedCollections.has(b.id);
    
    if (aPinned && !bPinned) return -1;
    if (!aPinned && bPinned) return 1;
    if (!aComplete && bComplete) return -1;
    if (aComplete && !bComplete) return 1;
    return 0;
  });
  
  if (sorted.length === 0) {
    container.innerHTML = `<div class="library-empty">${search ? 'No matches' : 'No collections yet'}</div>`;
    return;
  }
  
  container.innerHTML = sorted.map(col => {
    const isActive = selectedCollection?.id === col.id;
    const isPinned = pinnedCollections.has(col.id);
    const isComplete = completedCollections.has(col.id);
    const memberCount = collectionMembers[col.id]?.length || 0;
    
    return `
      <div class="collection-item ${isActive ? 'active' : ''} ${isComplete ? 'complete' : ''}" 
           onclick="selectCollection('${col.id}')"
           oncontextmenu="openContextMenu(event, '${col.id}')"
           data-id="${col.id}">
        <div class="collection-icon">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
        </div>
        <div class="collection-info">
          <div class="collection-name">${col.name}</div>
          <div class="collection-meta">${isComplete ? 'Complete' : memberCount ? memberCount + ' docs' : 'Empty'}</div>
        </div>
        <div class="collection-actions">
          <button class="collection-action ${isPinned ? 'pinned' : ''}" onclick="event.stopPropagation(); togglePin('${col.id}')" title="Pin">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="${isPinned ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
              <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
            </svg>
          </button>
          <button class="collection-action" onclick="event.stopPropagation(); openContextMenu(event, '${col.id}')" title="More">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
            </svg>
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function renderLibrary() {
  const container = document.getElementById('libraryList');
  
  if (!selectedCollection) {
    container.innerHTML = '<div class="library-empty">Select a collection</div>';
    document.getElementById('libraryTitle').textContent = 'Documents';
    return;
  }
  
  document.getElementById('libraryTitle').textContent = 'Documents';
  
  const memberIds = collectionMembers[selectedCollection.id] || [];
  const docs = allDocuments.filter(d => memberIds.includes(d.id));
  
  if (docs.length === 0) {
    container.innerHTML = '<div class="library-empty">No documents yet</div>';
    return;
  }
  
  container.innerHTML = docs.map(doc => `
    <div class="library-item ${doc.processing ? 'processing' : ''}" ${doc.processing ? '' : `onclick="viewDocument('${doc.id}')"`}>
      <div class="library-item-icon">
        ${doc.processing 
          ? '<div class="spinner" style="width:12px;height:12px;border-width:1.5px"></div>'
          : '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>'
        }
      </div>
      <div class="library-item-info">
        <div class="library-item-name" title="${doc.name}">${doc.name}</div>
        <div class="library-item-meta">${doc.date}</div>
      </div>
      ${doc.processing ? '' : `
        <button class="library-item-delete" onclick="event.stopPropagation(); deleteDocument('${doc.id}')" title="Remove">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      `}
    </div>
  `).join('');
}

// ===== COLLECTION ACTIONS =====
async function selectCollection(colId) {
  selectedCollection = collections.find(c => c.id === colId);
  renderCollections();
  updateUploadTarget();
  
  document.getElementById('mainTitle').innerHTML = selectedCollection.name;
  document.getElementById('libraryAddBtn').disabled = false;
  
  await loadCollectionMembers(colId);
  renderLibrary();
  await loadChecklist(colId);
}

function updateUploadTarget() {
  const targetEl = document.getElementById('uploadTarget');
  const nameEl = document.getElementById('uploadTargetName');
  
  if (selectedCollection) {
    nameEl.textContent = selectedCollection.name;
    targetEl.classList.remove('no-collection');
  } else {
    nameEl.textContent = 'New Collection';
    targetEl.classList.add('no-collection');
  }
}

async function loadChecklist(colId) {
  const area = document.getElementById('contentArea');
  area.innerHTML = `<div class="loading-content"><div class="spinner"></div><span>Loading...</span></div>`;
  
  try {
    const memberIds = collectionMembers[colId] || [];
    
    let checklistDoc = null;
    for (const id of memberIds) {
      const doc = allDocuments.find(d => d.id === id);
      if (doc && (doc.name.toLowerCase().includes('checklist') || doc.source?.endsWith('.md'))) {
        checklistDoc = doc;
        break;
      }
    }
    
    if (checklistDoc) {
      const content = await fetchDocContent(checklistDoc.source);
      area.innerHTML = `<div class="checklist">${marked.parse(content)}</div>`;
      styleStatusCells(area);
    } else {
      area.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
          </div>
          <h2 class="empty-title">No checklist yet</h2>
          <p class="empty-text">Upload documents to automatically generate a checklist for this collection.</p>
        </div>
      `;
    }
  } catch (err) {
    console.error('Checklist load error:', err);
    area.innerHTML = `<div class="empty-state"><p style="color:var(--error)">Failed to load checklist</p></div>`;
  }
}

function styleStatusCells(container) {
  container.querySelectorAll('td').forEach(td => {
    const text = td.textContent.trim().toLowerCase();
    if (text === 'complete') td.classList.add('status-complete');
    else if (text === 'incomplete') td.classList.add('status-incomplete');
    else if (text === 'partial') td.classList.add('status-partial');
  });
}

async function fetchDocContent(source) {
  const { url } = await api('/objects/download-url', {
    method: 'POST',
    body: JSON.stringify({ file: source, format: 'original' })
  });
  const res = await fetch(url);
  return await res.text();
}

async function createCollection() {
  const name = prompt('Collection name:');
  if (!name?.trim()) return;
  
  try {
    const col = await apiAuth('/collections', {
      method: 'POST',
      body: JSON.stringify({ name: name.trim(), description: '', dynamic: false })
    });
    
    if (col?.id) {
      collections.unshift(col);
    } else {
      await loadCollections();
    }
    
    renderCollections();
    showToast(`Created "${name}"`, 'success');
  } catch (err) {
    console.error('Create failed:', err);
    showToast('Failed to create', 'error');
  }
}

function togglePin(colId) {
  if (pinnedCollections.has(colId)) {
    pinnedCollections.delete(colId);
  } else {
    pinnedCollections.add(colId);
  }
  savePinned();
  renderCollections();
}

// ===== CONTEXT MENU =====
function openContextMenu(event, colId) {
  event.preventDefault();
  event.stopPropagation();
  
  const menu = document.getElementById('contextMenu');
  menuTargetCollection = collections.find(c => c.id === colId);
  
  const isComplete = completedCollections.has(colId);
  document.getElementById('completeMenuText').textContent = isComplete ? 'Reopen' : 'Mark Complete';
  
  menu.style.top = event.clientY + 'px';
  menu.style.left = event.clientX + 'px';
  menu.classList.add('open');
}

function closeContextMenu() {
  document.getElementById('contextMenu').classList.remove('open');
  menuTargetCollection = null;
}

async function renameCollection() {
  if (!menuTargetCollection) return;
  const targetCol = menuTargetCollection;
  closeContextMenu();
  
  const newName = prompt('New name:', targetCol.name);
  if (!newName?.trim() || newName === targetCol.name) return;
  
  try {
    await apiAuth(`/collections/${targetCol.id}`, {
      method: 'PUT',
      body: JSON.stringify({ name: newName.trim() })
    });
    
    targetCol.name = newName.trim();
    renderCollections();
    
    if (selectedCollection?.id === targetCol.id) {
      document.getElementById('mainTitle').innerHTML = newName.trim();
    }
    
    showToast('Renamed', 'success');
  } catch (err) {
    console.error('Rename failed:', err);
    showToast('Failed to rename', 'error');
  }
}

function toggleCompleteCollection() {
  if (!menuTargetCollection) return;
  const colId = menuTargetCollection.id;
  closeContextMenu();
  
  if (completedCollections.has(colId)) {
    completedCollections.delete(colId);
    showToast('Reopened');
  } else {
    completedCollections.add(colId);
    pinnedCollections.delete(colId);
    savePinned();
    showToast('Marked complete', 'success');
  }
  saveCompleted();
  renderCollections();
}

async function deleteCollection() {
  if (!menuTargetCollection) return;
  const targetCol = menuTargetCollection;
  closeContextMenu();
  
  if (!confirm(`Delete "${targetCol.name}"?`)) return;
  
  try {
    await api(`/collections/${targetCol.id}`, { method: 'DELETE' });
    
    collections = collections.filter(c => c.id !== targetCol.id);
    pinnedCollections.delete(targetCol.id);
    completedCollections.delete(targetCol.id);
    savePinned();
    saveCompleted();
    
    if (selectedCollection?.id === targetCol.id) {
      selectedCollection = null;
      updateUploadTarget();
      document.getElementById('mainTitle').innerHTML = '<span class="main-title-empty">Select a collection</span>';
      document.getElementById('contentArea').innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
            </svg>
          </div>
          <h2 class="empty-title">No collection selected</h2>
          <p class="empty-text">Select a collection from the sidebar to view its checklist and documents.</p>
        </div>
      `;
      renderLibrary();
    }
    
    renderCollections();
    showToast('Deleted', 'success');
  } catch (err) {
    console.error('Delete failed:', err);
    showToast('Failed to delete', 'error');
  }
}

// ===== DOCUMENT VIEWER =====
async function viewDocument(docId) {
  const doc = allDocuments.find(d => d.id === docId);
  if (!doc) return;
  
  const dialog = document.getElementById('docViewer');
  document.getElementById('viewerTitle').textContent = doc.name;
  document.getElementById('viewerBody').innerHTML = `<div class="loading-content"><div class="spinner"></div><span>Loading...</span></div>`;
  
  dialog.showModal();
  
  try {
    const content = await fetchDocContent(doc.source);
    document.getElementById('viewerBody').innerHTML = marked.parse(content);
  } catch (err) {
    document.getElementById('viewerBody').innerHTML = `<p style="color:var(--error);text-align:center;padding:40px">Failed to load</p>`;
  }
}

function closeViewer() {
  document.getElementById('docViewer').close();
}

// ===== DOCUMENT MANAGEMENT =====
async function deleteDocument(docId) {
  const doc = allDocuments.find(d => d.id === docId);
  if (!doc || !selectedCollection) return;
  
  if (!confirm(`Remove "${doc.name}"?`)) return;
  
  try {
    await api(`/collections/${selectedCollection.id}/members/${docId}`, { method: 'DELETE' });
    
    if (collectionMembers[selectedCollection.id]) {
      collectionMembers[selectedCollection.id] = collectionMembers[selectedCollection.id].filter(id => id !== docId);
    }
    
    renderLibrary();
    showToast('Removed', 'success');
  } catch (err) {
    showToast('Failed to remove', 'error');
  }
}

// ===== DOCUMENT PICKER =====
function openDocumentPicker() {
  if (!selectedCollection) return;
  
  document.getElementById('pickerSearch').value = '';
  renderDocumentPicker();
  document.getElementById('docPicker').showModal();
}

function closeDocumentPicker() {
  document.getElementById('docPicker').close();
}

function renderDocumentPicker() {
  const container = document.getElementById('pickerBody');
  const search = document.getElementById('pickerSearch').value.toLowerCase();
  
  const memberIds = selectedCollection ? (collectionMembers[selectedCollection.id] || []) : [];
  
  const filtered = allDocuments.filter(d => {
    if (!search) return true;
    return d.name.toLowerCase().includes(search);
  });
  
  if (filtered.length === 0) {
    container.innerHTML = '<div class="picker-empty">No documents found</div>';
    return;
  }
  
  container.innerHTML = filtered.map(doc => {
    const inCollection = memberIds.includes(doc.id);
    return `
      <div class="picker-item">
        <div class="picker-item-icon">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
        </div>
        <div class="picker-item-info">
          <div class="picker-item-name">${doc.name}</div>
          <div class="picker-item-meta">${doc.date}</div>
        </div>
        ${inCollection 
          ? '<span class="picker-added">Added</span>'
          : `<button class="picker-add-btn" onclick="addDocumentToCollection('${doc.id}')">Add</button>`
        }
      </div>
    `;
  }).join('');
}

async function addDocumentToCollection(docId) {
  if (!selectedCollection) return;
  
  try {
    await api(`/collections/${selectedCollection.id}/members`, {
      method: 'POST',
      body: JSON.stringify({ id: docId })
    });
    
    if (!collectionMembers[selectedCollection.id]) {
      collectionMembers[selectedCollection.id] = [];
    }
    collectionMembers[selectedCollection.id].push(docId);
    
    renderDocumentPicker();
    renderLibrary();
    
    const doc = allDocuments.find(d => d.id === docId);
    showToast(`Added "${doc?.name}"`, 'success');
  } catch (err) {
    showToast('Failed to add', 'error');
  }
}

// ===== FILE UPLOAD =====
function setupDragDrop() {
  const zone = document.getElementById('uploadZone');
  
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
    zone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
  });
  
  ['dragenter', 'dragover'].forEach(e => zone.addEventListener(e, () => zone.classList.add('dragover')));
  ['dragleave', 'drop'].forEach(e => zone.addEventListener(e, () => zone.classList.remove('dragover')));
  
  zone.addEventListener('drop', e => {
    const files = Array.from(e.dataTransfer.files);
    if (files.length) handleFiles(files);
  });
}

function setupFileInput() {
  document.getElementById('fileInput').addEventListener('change', e => {
    const files = Array.from(e.target.files);
    if (files.length) handleFiles(files);
    e.target.value = '';
  });
}

async function handleFiles(files) {
  for (const file of files) {
    await processFile(file);
  }
}

async function processFile(file) {
  const queueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  addToQueue(queueId, file.name);
  
  const mimeType = file.type || getMimeType(file.name);
  
  try {
    updateQueueStatus(queueId, 'Uploading...', 'processing');
    const jwtRes = await fetch(`${CONFIG.AUTH_BASE}/auth/token?token=${CONFIG.API_KEY}`, {
      headers: { 'Authorization': `Bearer ${CONFIG.API_KEY}` }
    });
    if (!jwtRes.ok) throw new Error('Auth failed');
    const jwt = (await jwtRes.json()).token;

    const uploadRes = await fetch(`${CONFIG.API_BASE}/objects/upload-url`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${CONFIG.API_KEY}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: file.name, mime_type: mimeType })
    });
    if (!uploadRes.ok) throw new Error('Upload URL failed');
    const uploadData = await uploadRes.json();

    const putRes = await fetch(uploadData.url, {
      method: 'PUT',
      headers: { 'Content-Type': mimeType },
      body: file
    });
    if (!putRes.ok) throw new Error('Upload failed');

    updateQueueStatus(queueId, 'Processing...', 'processing');
    const createRes = await fetch(`${CONFIG.API_BASE}/objects`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${jwt}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: file.name,
        content: { source: uploadData.id, type: mimeType, name: file.name }
      })
    });
    if (!createRes.ok) throw new Error('Create failed');
    const obj = await createRes.json();

    const newDoc = {
      id: obj.id,
      name: file.name,
      type: 'Document',
      date: formatDate(new Date().toISOString()),
      source: uploadData.id,
      processing: true
    };
    allDocuments.push(newDoc);
    
    if (selectedCollection) {
      if (!collectionMembers[selectedCollection.id]) {
        collectionMembers[selectedCollection.id] = [];
      }
      collectionMembers[selectedCollection.id].push(obj.id);
      renderLibrary();
    }

    const targetCollection = selectedCollection ? selectedCollection.id : 'NEW';
    
    await fetch(`${CONFIG.API_BASE}/execute/async`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${jwt}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'conversation',
        interaction: CONFIG.INTERACTION,
        data: { task: obj.id, target_collection: targetCollection },
        config: {
          environment: '681915c6a01fb262a410c161',
          model: 'publishers/anthropic/models/claude-sonnet-4'
        },
        interactive: true,
        max_iterations: 100
      })
    });

    const docIndex = allDocuments.findIndex(d => d.id === obj.id);
    if (docIndex !== -1) {
      allDocuments[docIndex].processing = false;
      renderLibrary();
    }

    updateQueueStatus(queueId, 'Complete', 'complete');
    showToast(`${file.name} uploaded`, 'success');

  } catch (err) {
    console.error('Upload error:', err);
    updateQueueStatus(queueId, 'Failed', 'error');
    showToast(`Failed: ${file.name}`, 'error');
  }
}

function getMimeType(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const types = {
    pdf: 'application/pdf',
    docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    doc: 'application/msword',
    txt: 'text/plain',
    md: 'text/markdown',
    png: 'image/png',
    jpg: 'image/jpeg',
    jpeg: 'image/jpeg',
    xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    xls: 'application/vnd.ms-excel',
    csv: 'text/csv'
  };
  return types[ext] || 'application/octet-stream';
}

function addToQueue(id, name) {
  const queue = document.getElementById('uploadQueue');
  const item = document.createElement('div');
  item.className = 'queue-item';
  item.id = `queue-${id}`;
  item.innerHTML = `
    <div class="queue-icon">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
      </svg>
    </div>
    <div class="queue-info">
      <div class="queue-name">${name}</div>
      <div class="queue-status processing" id="status-${id}">Preparing...</div>
    </div>
    <div class="queue-spinner" id="spinner-${id}"></div>
  `;
  queue.appendChild(item);
}

function updateQueueStatus(id, status, state = 'processing') {
  const statusEl = document.getElementById(`status-${id}`);
  const spinnerEl = document.getElementById(`spinner-${id}`);
  
  if (statusEl) {
    statusEl.textContent = status;
    statusEl.className = `queue-status ${state}`;
  }
  
  if (spinnerEl) {
    if (state === 'complete') {
      spinnerEl.outerHTML = `<svg class="queue-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>`;
    } else if (state === 'error') {
      spinnerEl.outerHTML = `<svg style="color:var(--error)" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`;
    }
  }
}

// ===== UTILITY =====
function setupClickOutside() {
  document.addEventListener('click', e => {
    if (!e.target.closest('.collection-action') && !e.target.closest('.context-menu')) {
      closeContextMenu();
    }
  });
}

function showToast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    ${type === 'success' ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>' : 
      type === 'error' ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>' :
      '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'}
    <span>${msg}</span>
  `;
  container.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
}
</script>
</body>
</html>
