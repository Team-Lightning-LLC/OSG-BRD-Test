<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSG Document Processing - PathB</title>
  
  <!-- SECURITY: Content Security Policy - restricts where scripts/styles can load from -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline';
    connect-src 'self' https://api.vertesia.io https://*.googleapis.com https://storage.googleapis.com;
    img-src 'self' data: https:;
    font-src 'self';
  ">
  <!-- SECURITY: Prevent MIME type sniffing -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230d2137'/%3E%3Crect x='2' y='24' width='28' height='3' rx='1.5' fill='%232a7d8c'/%3E%3Ctext x='16' y='19' text-anchor='middle' font-family='system-ui' font-size='13' font-weight='800' fill='white'%3EOSG%3C/text%3E%3C/svg%3E">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
  <style>
    :root {
      --primary: #0d2137;
      --primary-light: #1a3a5c;
      --accent: #2a7d8c;
      --accent-light: #3a9aad;
      --accent-soft: #e6f3f5;
      --ink: #1f2d3d;
      --muted: #6c7a89;
      --border: #dde2e8;
      --bg: #f5f7f9;
      --card: #ffffff;
      --success: #28a745;
      --success-soft: #e8f5e9;
      --warning: #f0ad4e;
      --warning-soft: #fef9e8;
      --shadow: 0 2px 8px rgba(13,33,55,0.08);
      --shadow-lg: 0 4px 16px rgba(13,33,55,0.12);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--ink);
      height: 100%;
      overflow: hidden;
    }
    
    /* ===== AUTH GATE STYLES ===== */
    .auth-gate {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .auth-gate.hidden { display: none; }
    
    .auth-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    
    .auth-logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
    }
    
    .auth-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
    }
    
    .auth-subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 24px;
    }
    
    .auth-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
      transition: border-color 0.15s;
    }
    
    .auth-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .auth-input.error {
      border-color: #dc3545;
      animation: shake 0.3s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }
    
    .auth-btn {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .auth-btn:hover { background: var(--accent-light); }
    
    .auth-error {
      color: #dc3545;
      font-size: 12px;
      margin-top: 12px;
      display: none;
    }
    
    .auth-error.show { display: block; }
    
    .security-badge {
      margin-top: 24px;
      padding: 10px 16px;
      background: var(--bg);
      border-radius: 8px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .security-badge svg { color: var(--success); }
    
    .https-warning {
      background: #fff3cd;
      color: #856404;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 12px;
      margin-top: 16px;
      display: none;
    }
    
    .https-warning.show { display: block; }
    
    /* ===== SESSION TIMEOUT BANNER ===== */
    .session-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--warning);
      color: #333;
      padding: 8px 16px;
      text-align: center;
      font-size: 13px;
      z-index: 1001;
      display: none;
    }
    
    .session-banner.show { display: block; }
    
    .session-banner button {
      background: white;
      border: none;
      padding: 4px 12px;
      border-radius: 4px;
      margin-left: 12px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      padding: 14px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-lg);
      flex-shrink: 0;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo {
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .logo svg {
      width: 42px;
      height: 42px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .brand-text { color: white; }
    .brand-name { font-size: 18px; font-weight: 700; }
    .brand-sub { font-size: 11px; opacity: 0.8; }
    
    .header-status {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-size: 13px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4ade80;
    }
    
    .status-dot.disconnected { background: #f87171; }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .logout-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s;
    }
    
    .logout-btn:hover { background: rgba(255,255,255,0.2); }
    
    /* Main Container */
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px 32px;
      overflow: hidden;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
    }
    
    /* Section Header */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      flex-shrink: 0;
    }
    
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Collections Scroll */
    .collections-wrapper {
      flex-shrink: 0;
      margin-bottom: 20px;
    }
    
    .collections-scroll {
      display: flex;
      gap: 14px;
      overflow-x: auto;
      padding-bottom: 8px;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    
    .collections-scroll::-webkit-scrollbar { height: 6px; }
    .collections-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    
    /* Collection Card */
    .collection-card {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 14px 18px;
      min-width: 200px;
      max-width: 200px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
      flex-shrink: 0;
    }
    
    .collection-card:hover { border-color: var(--accent); box-shadow: var(--shadow); }
    .collection-card.active { border-color: var(--accent); background: var(--accent-soft); }
    
    .collection-card.complete {
      border-color: var(--success);
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.15);
    }
    
    .collection-card.complete:hover {
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.25);
    }
    
    .collection-card.new {
      border-style: dashed;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 95px;
      color: var(--muted);
    }
    
    .collection-card.new:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }
    
    .collection-card.new svg { margin-bottom: 6px; }
    
    .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    
    .card-icon {
      width: 30px;
      height: 30px;
      background: var(--accent-soft);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      flex-shrink: 0;
    }
    
    .collection-card.complete .card-icon {
      background: var(--success-soft);
      color: var(--success);
    }
    
    .card-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }
    
    .card-pin {
      position: absolute;
      top: 6px;
      right: 6px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      padding: 4px;
      border-radius: 4px;
      opacity: 0;
      transition: all 0.15s;
    }
    
    .collection-card:hover .card-pin { opacity: 1; }
    .card-pin:hover { background: var(--bg); }
    .card-pin.active { color: var(--warning); opacity: 1; }
    
    .card-menu-btn {
      position: absolute;
      top: 6px;
      right: 28px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      padding: 4px;
      border-radius: 4px;
      opacity: 0;
      transition: all 0.15s;
    }
    
    .collection-card:hover .card-menu-btn { opacity: 1; }
    .card-menu-btn:hover { background: var(--bg); color: var(--ink); }
    
    .card-meta {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    
    .card-status { font-weight: 500; }
    .card-status.active { color: var(--accent); }
    .card-status.complete { color: var(--success); }
    
    .card-badge {
      display: inline-block;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 10px;
      font-weight: 500;
    }
    
    .card-badge.ready { background: var(--success-soft); color: var(--success); }
    .card-badge.processing { background: var(--accent-soft); color: var(--accent); }
    .card-badge.setting-up { background: var(--warning-soft); color: #b8860b; }
    
    .collection-card.setting-up {
      border-color: var(--warning);
      opacity: 0.85;
      cursor: wait;
    }
    
    .card-icon-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--warning);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    /* Card Dropdown Menu */
    .card-dropdown {
      position: fixed;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      min-width: 140px;
      z-index: 1000;
      display: none;
    }
    
    .card-dropdown.open { display: block; }
    
    .card-dropdown-item {
      padding: 10px 14px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--ink);
    }
    
    .card-dropdown-item:first-child { border-radius: 8px 8px 0 0; }
    .card-dropdown-item:last-child { border-radius: 0 0 8px 8px; }
    .card-dropdown-item:hover { background: var(--bg); }
    .card-dropdown-item.danger { color: #dc3545; }
    .card-dropdown-item.danger:hover { background: #fdf0ef; }
    .card-dropdown-item svg { width: 14px; height: 14px; }
    
    /* Main Grid */
    .main-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
      min-height: 0;
      overflow: hidden;
    }
    
    /* Panel */
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }
    
    .panel-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    
    .panel-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .panel-body {
      flex: 1;
      padding: 18px;
      overflow-y: auto;
      min-height: 0;
    }
    
    /* Checklist Area */
    .checklist-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 250px;
      color: var(--muted);
      text-align: center;
    }
    
    .checklist-empty svg { margin-bottom: 16px; opacity: 0.4; }
    .checklist-empty p { font-size: 14px; margin-bottom: 4px; }
    .checklist-empty small { font-size: 12px; opacity: 0.7; }
    
    /* Markdown Checklist */
    .checklist-content { font-size: 13px; line-height: 1.6; }
    
    .checklist-content h1 {
      font-size: 18px;
      color: var(--primary);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 8px;
      margin-bottom: 16px;
    }
    
    .checklist-content h2 {
      font-size: 15px;
      color: var(--ink);
      margin: 18px 0 10px;
      padding-left: 10px;
      border-left: 3px solid var(--accent);
    }
    
    .checklist-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 14px 0;
      font-size: 11px;
    }
    
    .checklist-content th {
      background: var(--primary);
      color: white;
      padding: 8px 10px;
      text-align: left;
      font-weight: 600;
    }
    
    .checklist-content td {
      padding: 8px 10px;
      border: 1px solid var(--border);
    }
    
    .checklist-content tr:nth-child(even) { background: var(--bg); }
    
    /* Upload Section */
    .upload-section { margin-bottom: 16px; flex-shrink: 0; }
    
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 24px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
      background: var(--bg);
    }
    
    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--accent);
      background: var(--accent-soft);
    }
    
    .upload-zone svg { color: var(--accent); margin-bottom: 10px; }
    .upload-zone p { font-size: 13px; color: var(--ink); margin-bottom: 4px; }
    .upload-zone small { font-size: 11px; color: var(--muted); }
    .upload-zone input { display: none; }
    
    /* Upload Target Indicator */
    .upload-target {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      padding: 8px 12px;
      background: var(--bg);
      border-radius: 6px;
      font-size: 11px;
    }
    
    .upload-target-label {
      color: var(--muted);
    }
    
    .upload-target-name {
      color: var(--accent);
      font-weight: 600;
    }
    
    .upload-target.no-collection .upload-target-name {
      color: var(--warning);
    }
    
    /* Upload Queue */
    .upload-queue { margin-top: 12px; }
    
    .queue-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 6px;
    }
    
    .queue-item-icon {
      width: 32px;
      height: 32px;
      background: var(--accent-soft);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      flex-shrink: 0;
    }
    
    .queue-item-info { flex: 1; min-width: 0; }
    
    .queue-item-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .queue-item-status { font-size: 10px; color: var(--muted); }
    .queue-item-status.processing { color: var(--accent); }
    .queue-item-status.complete { color: var(--success); }
    .queue-item-status.error { color: #dc3545; }
    
    .queue-item-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      flex-shrink: 0;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .queue-item-check { color: var(--success); flex-shrink: 0; }
    
    /* Library Section */
    .library-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      border-top: 1px solid var(--border);
      padding-top: 14px;
      margin-top: 14px;
    }
    
    .library-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-shrink: 0;
    }
    
    .library-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .library-search { position: relative; }
    
    .library-search input {
      padding: 5px 8px 5px 26px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 11px;
      width: 120px;
      background: var(--bg);
    }
    
    .library-search input:focus {
      outline: none;
      border-color: var(--accent);
      background: white;
    }
    
    .library-search svg {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
    }
    
    .library-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .library-add-btn {
      width: 26px;
      height: 26px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .library-add-btn:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }
    
    .library-add-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .library-list {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }
    
    .library-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .library-item:hover { background: var(--bg); }
    
    .library-item-icon {
      width: 26px;
      height: 26px;
      background: var(--accent-soft);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      flex-shrink: 0;
    }
    
    .library-item-info { flex: 1; min-width: 0; }
    
    .library-item-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .library-item-meta { font-size: 10px; color: var(--muted); }
    
    .library-item.processing {
      opacity: 0.6;
      cursor: default;
    }
    
    .library-item.processing:hover {
      background: transparent;
    }
    
    .library-item.processing .library-item-name {
      color: var(--muted);
    }
    
    .library-item-spinner {
      width: 12px;
      height: 12px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .library-item-delete {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      padding: 4px;
      border-radius: 4px;
      opacity: 0;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    
    .library-item:hover .library-item-delete {
      opacity: 1;
    }
    
    .library-item-delete:hover {
      background: #fdf0ef;
      color: #dc3545;
    }
    
    .library-empty {
      text-align: center;
      padding: 30px 16px;
      color: var(--muted);
      font-size: 12px;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.3s;
    }
    
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    
    .loading-spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    .loading-text { margin-top: 14px; color: var(--muted); font-size: 13px; }
    
    /* Toast */
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
    
    .toast {
      background: var(--primary);
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      margin-top: 8px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      animation: slideIn 0.3s ease;
    }
    
    .toast.success { background: var(--success); }
    .toast.error { background: #dc3545; }
    .toast.warning { background: var(--warning); color: #333; }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Button */
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-light); }
    .btn-secondary { background: var(--bg); color: var(--ink); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
    
    /* Document Viewer Dialog */
    dialog#docViewer {
      width: min(900px, 90vw);
      height: min(80vh, 700px);
      border: 0;
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      margin: auto;
      position: fixed;
      top: 75%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    dialog#docViewer::backdrop { background: rgba(13,33,55,0.6); }
    
    .viewer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: var(--primary);
      color: white;
    }
    
    .viewer-title {
      font-size: 15px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      margin-right: 16px;
    }
    
    .viewer-close {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .viewer-close:hover { background: rgba(255,255,255,0.2); }
    
    .viewer-body {
      padding: 24px 32px;
      overflow-y: auto;
      height: calc(100% - 60px);
      font-size: 14px;
      line-height: 1.7;
    }
    
    .viewer-body h1 {
      font-size: 22px;
      color: var(--primary);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 10px;
      margin: 24px 0 16px;
    }
    
    .viewer-body h1:first-child { margin-top: 0; }
    
    .viewer-body h2 {
      font-size: 17px;
      color: var(--ink);
      margin: 20px 0 12px;
      border-left: 3px solid var(--accent);
      padding-left: 12px;
    }
    
    .viewer-body h3 { font-size: 15px; margin: 16px 0 10px; }
    .viewer-body p { margin-bottom: 14px; }
    .viewer-body ul, .viewer-body ol { margin: 12px 0; padding-left: 24px; }
    .viewer-body li { margin-bottom: 6px; }
    
    .viewer-body table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      font-size: 13px;
    }
    
    .viewer-body th {
      background: var(--primary);
      color: white;
      padding: 10px 12px;
      text-align: left;
    }
    
    .viewer-body td {
      padding: 10px 12px;
      border: 1px solid var(--border);
    }
    
    .viewer-body tr:nth-child(even) { background: var(--bg); }
    
    .viewer-body pre {
      background: var(--bg);
      padding: 14px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
    }
    
    .viewer-body code {
      background: var(--bg);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .viewer-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--muted);
      gap: 12px;
    }
    
    /* Document Picker Dialog */
    dialog#docPicker {
      width: min(600px, 90vw);
      height: min(70vh, 500px);
      border: 0;
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      margin: auto;
      display: flex;
      flex-direction: column;
    }
    
    dialog#docPicker::backdrop { background: rgba(13,33,55,0.6); }
    
    .picker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: var(--primary);
      color: white;
      flex-shrink: 0;
    }
    
    .picker-title {
      font-size: 15px;
      font-weight: 600;
    }
    
    .picker-search {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      position: relative;
      flex-shrink: 0;
    }
    
    .picker-search input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      background: var(--bg);
    }
    
    .picker-search input:focus {
      outline: none;
      border-color: var(--accent);
      background: white;
    }
    
    .picker-search svg {
      position: absolute;
      left: 28px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
    }
    
    .picker-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    .picker-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      transition: background 0.15s;
    }
    
    .picker-item:hover { background: var(--bg); }
    
    .picker-item-icon {
      width: 32px;
      height: 32px;
      background: var(--accent-soft);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      flex-shrink: 0;
    }
    
    .picker-item-info {
      flex: 1;
      min-width: 0;
    }
    
    .picker-item-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .picker-item-meta {
      font-size: 11px;
      color: var(--muted);
    }
    
    .picker-item-action {
      flex-shrink: 0;
    }
    
    .picker-add-btn {
      padding: 6px 12px;
      border: 1px solid var(--accent);
      border-radius: 6px;
      background: white;
      color: var(--accent);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .picker-add-btn:hover {
      background: var(--accent);
      color: white;
    }
    
    .picker-added {
      padding: 6px 12px;
      border-radius: 6px;
      background: var(--success-soft);
      color: var(--success);
      font-size: 11px;
      font-weight: 600;
    }
    
    .picker-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 13px;
    }
  </style>
</head>
<body>
  <!-- ===== AUTH GATE ===== -->
  <div class="auth-gate" id="authGate">
    <div class="auth-box">
      <svg class="auth-logo" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="32" height="32" rx="6" fill="#0d2137"/>
        <rect x="2" y="24" width="28" height="3" rx="1.5" fill="#2a7d8c"/>
        <text x="16" y="19" text-anchor="middle" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif" font-size="13" font-weight="800" fill="white" letter-spacing="0.5">OSG</text>
      </svg>
      <h1 class="auth-title">Document Processing Portal</h1>
      <p class="auth-subtitle">Enter access code to continue</p>
      <input type="password" class="auth-input" id="authInput" placeholder="Access Code" autocomplete="off">
      <button class="auth-btn" onclick="attemptLogin()">Continue</button>
      <p class="auth-error" id="authError">Invalid access code. Please try again.</p>
      <div class="https-warning" id="httpsWarning">
        âš ï¸ This page is not using HTTPS. Data transmission may not be secure.
      </div>
      <div class="security-badge">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        Secure Document Upload
      </div>
    </div>
  </div>

  <!-- ===== SESSION TIMEOUT BANNER ===== -->
  <div class="session-banner" id="sessionBanner">
    Your session will expire soon due to inactivity.
    <button onclick="resetSessionTimer()">Stay Logged In</button>
  </div>

  <div class="app-container">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">Connecting to Vertesia...</div>
    </div>

    <!-- Header -->
    <header class="header">
      <div class="logo-section">
        <div class="logo">
          <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="32" height="32" rx="6" fill="#0d2137"/>
            <rect x="2" y="24" width="28" height="3" rx="1.5" fill="#2a7d8c"/>
            <text x="16" y="19" text-anchor="middle" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif" font-size="13" font-weight="800" fill="white" letter-spacing="0.5">OSG</text>
          </svg>
        </div>
        <div class="brand-text">
          <div class="brand-name">Document Processing</div>
          <div class="brand-sub">Client Onboarding Automation</div>
        </div>
      </div>
      <div class="header-actions">
        <div class="header-status">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Connected</span>
        </div>
        <button class="logout-btn" onclick="logout()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          Logout
        </button>
      </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
      <!-- Collections Section -->
      <div class="collections-wrapper">
        <div class="section-header">
          <h2 class="section-title">Collections</h2>
        </div>
        <div class="collections-scroll" id="collectionsScroll">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Main Grid -->
      <div class="main-grid">
        <!-- Left: Checklist Panel -->
        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title" id="collectionTitle">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
              Select a Collection
            </h3>
            <button class="btn btn-secondary" onclick="refreshData()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
              Refresh
            </button>
          </div>
          <div class="panel-body" id="checklistArea">
            <div class="checklist-empty">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 11l3 3L22 4"/>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
              </svg>
              <p>Select a collection to view its checklist</p>
              <small>Checklists are auto-generated from uploaded documents</small>
            </div>
          </div>
        </div>

        <!-- Right: Upload & Library Panel -->
        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Upload Documents
            </h3>
          </div>
          <div class="panel-body">
            <!-- Upload Zone -->
            <div class="upload-section">
              <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <p>Click to upload or drag files here</p>
                <small>PDF, DOCX, TXT, Images supported</small>
                <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.txt,.png,.jpg,.jpeg,.xlsx,.xls,.csv,.md">
              </div>
              <div class="upload-target" id="uploadTarget">
                <span class="upload-target-label">Upload to:</span>
                <span class="upload-target-name" id="uploadTargetName">New Collection (auto-create)</span>
              </div>
              <div class="upload-queue" id="uploadQueue"></div>
            </div>

            <!-- Library Section -->
            <div class="library-section">
              <div class="library-header">
                <h4 class="library-title">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  <span id="libraryTitle">Collection Library</span>
                </h4>
                <div class="library-actions">
                  <button class="library-add-btn" id="libraryAddBtn" onclick="openDocumentPicker()" title="Add existing documents" disabled>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                  </button>
                  <div class="library-search">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" placeholder="Search..." id="librarySearch" oninput="renderLibrary()">
                  </div>
                </div>
              </div>
              <div class="library-list" id="libraryList">
                <div class="library-empty">Select a collection to view documents</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card Dropdown Menu (positioned via JS) -->
  <div class="card-dropdown" id="cardDropdown">
    <div class="card-dropdown-item" onclick="renameCollection()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Rename
    </div>
    <div class="card-dropdown-item" onclick="toggleCompleteCollection()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
      <span id="completeMenuText">Mark Complete</span>
    </div>
    <div class="card-dropdown-item danger" onclick="deleteCollection()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
      Delete
    </div>
  </div>

  <!-- Document Viewer Dialog -->
  <dialog id="docViewer">
    <div class="viewer-header">
      <span class="viewer-title" id="viewerTitle">Document</span>
      <button class="viewer-close" onclick="closeViewer()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="viewer-body" id="viewerBody">
      <!-- Content rendered here -->
    </div>
  </dialog>

  <!-- Document Picker Dialog -->
  <dialog id="docPicker">
    <div class="picker-header">
      <span class="picker-title">Add Documents to Collection</span>
      <button class="viewer-close" onclick="closeDocumentPicker()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="picker-search">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" placeholder="Search all documents..." id="pickerSearch" oninput="renderDocumentPicker()">
    </div>
    <div class="picker-body" id="pickerBody">
      <!-- Content rendered here -->
    </div>
  </dialog>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

<script>
/*
 * =========================================================================
 * SECURITY NOTES FOR IT DEPARTMENT - PRODUCTION DEPLOYMENT
 * =========================================================================
 * 
 * This is a PROOF OF CONCEPT application. Before production deployment,
 * the following security improvements MUST be implemented:
 * 
 * CRITICAL (Must Fix):
 * --------------------
 * 1. API KEY EXPOSURE: The Vertesia API key is currently in client-side code.
 *    SOLUTION: Create a backend proxy (Node.js, Python, serverless function)
 *    that holds the API key server-side. Client calls your proxy, proxy calls Vertesia.
 * 
 * 2. AUTHENTICATION: Current password gate is client-side only (easily bypassed).
 *    SOLUTION: Implement proper authentication (OAuth, SAML, or integrate with
 *    your existing identity provider like Okta, Azure AD, etc.)
 * 
 * 3. HTTPS: Must be deployed with TLS/SSL certificate.
 *    SOLUTION: Use a service like Cloudflare, AWS Certificate Manager, or Let's Encrypt.
 * 
 * RECOMMENDED:
 * ------------
 * 4. Rate Limiting: Add rate limiting to prevent abuse
 * 5. Audit Logging: Log all document uploads with user identity
 * 6. Input Validation: Server-side validation of file types and sizes
 * 7. Session Management: Implement proper session tokens with server validation
 * 8. CSP Headers: Current CSP is basic - tighten for production
 * 
 * CURRENT POC SECURITY FEATURES:
 * ------------------------------
 * âœ“ Password gate (visual deterrent, not true security)
 * âœ“ HTTPS detection and warning
 * âœ“ Content Security Policy headers
 * âœ“ X-Frame-Options (clickjacking protection)
 * âœ“ Session timeout (30 min inactivity)
 * âœ“ Input sanitization for filenames
 * âœ“ Removed sensitive console.log statements
 * âœ“ Logout functionality clears tokens
 * 
 * =========================================================================
 */

// ===== SECURITY: Configuration =====
const SECURITY = {
  // CHANGE THIS PASSWORD before sharing!
  ACCESS_CODE: 'OSG2026Demo',
  
  // Session timeout in milliseconds (30 minutes)
  SESSION_TIMEOUT: 30 * 60 * 1000,
  
  // Warning before timeout (5 minutes before)
  SESSION_WARNING: 5 * 60 * 1000,
  
  // Max file size (50MB)
  MAX_FILE_SIZE: 50 * 1024 * 1024,
  
  // Allowed file extensions
  ALLOWED_EXTENSIONS: ['pdf', 'docx', 'doc', 'txt', 'png', 'jpg', 'jpeg', 'xlsx', 'xls', 'csv', 'md']
};

// ===== CONFIG =====
const CONFIG = {
  API_BASE: 'https://api.vertesia.io/api/v1',
  AUTH_BASE: 'https://api.vertesia.io',
  // NOTE FOR IT: This should be moved to a backend proxy in production
  API_KEY: 'sk-cf3c2d29bc38bfee2ae95bf107cb9046',
  INTERACTION: 'PathB',
  // Populate new collection agent
  POPULATE_INTERACTION: 'PopulateNewCollection',
  BLANK_CHECKLIST_ID: '6977a920e2e01f52d0fa2b49',
  BLANK_PROGRESS_ID: '6977a92034ea6462160b9002'
};

// ===== STATE =====
let jwtToken = null;
let tokenExpiry = null;
let collections = [];
let allDocuments = [];
let selectedCollection = null;
let collectionMembers = {};
let processingJobs = [];
let menuTargetCollection = null;
let sessionTimer = null;
let warningTimer = null;
let isAuthenticated = false;
let settingUpCollections = new Set(); // Track collections being populated with blank templates

// Persisted state
const PINNED_KEY = 'osg_pinned_collections';
const COMPLETE_KEY = 'osg_complete_collections';
const AUTH_KEY = 'osg_auth_session';
let pinnedCollections = new Set(JSON.parse(localStorage.getItem(PINNED_KEY) || '[]'));
let completedCollections = new Set(JSON.parse(localStorage.getItem(COMPLETE_KEY) || '[]'));

function savePinned() { localStorage.setItem(PINNED_KEY, JSON.stringify([...pinnedCollections])); }
function saveCompleted() { localStorage.setItem(COMPLETE_KEY, JSON.stringify([...completedCollections])); }

// ===== SECURITY: HTTPS Check =====
function checkHTTPS() {
  if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
    document.getElementById('httpsWarning').classList.add('show');
    // Log warning but don't block - let user proceed for demo purposes
  }
}

// ===== SECURITY: Input Sanitization =====
function sanitizeFilename(filename) {
  // Remove path traversal attempts and dangerous characters
  return filename
    .replace(/[<>:"/\\|?*\x00-\x1F]/g, '_')  // Remove dangerous chars
    .replace(/\.\./g, '_')                     // Remove path traversal
    .replace(/^\.+/, '')                       // Remove leading dots
    .substring(0, 255);                        // Limit length
}

function validateFile(file) {
  const errors = [];
  
  // Check file size
  if (file.size > SECURITY.MAX_FILE_SIZE) {
    errors.push(`File too large (max ${SECURITY.MAX_FILE_SIZE / 1024 / 1024}MB)`);
  }
  
  // Check extension
  const ext = file.name.split('.').pop().toLowerCase();
  if (!SECURITY.ALLOWED_EXTENSIONS.includes(ext)) {
    errors.push(`File type .${ext} not allowed`);
  }
  
  return errors;
}

// ===== SECURITY: Authentication Gate =====
function checkAuth() {
  const session = sessionStorage.getItem(AUTH_KEY);
  if (session) {
    const sessionData = JSON.parse(session);
    if (Date.now() < sessionData.expiry) {
      isAuthenticated = true;
      document.getElementById('authGate').classList.add('hidden');
      startSessionTimer();
      return true;
    }
  }
  return false;
}

function attemptLogin() {
  const input = document.getElementById('authInput');
  const error = document.getElementById('authError');
  
  if (input.value === SECURITY.ACCESS_CODE) {
    // Set session
    const sessionData = {
      authenticated: true,
      expiry: Date.now() + SECURITY.SESSION_TIMEOUT
    };
    sessionStorage.setItem(AUTH_KEY, JSON.stringify(sessionData));
    isAuthenticated = true;
    
    // Hide gate
    document.getElementById('authGate').classList.add('hidden');
    error.classList.remove('show');
    
    // Start session timer
    startSessionTimer();
    
    // Initialize app
    initializeApp();
  } else {
    input.classList.add('error');
    error.classList.add('show');
    setTimeout(() => input.classList.remove('error'), 300);
  }
}

function logout() {
  // Clear all session data
  sessionStorage.removeItem(AUTH_KEY);
  jwtToken = null;
  tokenExpiry = null;
  isAuthenticated = false;
  
  // Clear timers
  if (sessionTimer) clearTimeout(sessionTimer);
  if (warningTimer) clearTimeout(warningTimer);
  
  // Show auth gate
  document.getElementById('authGate').classList.remove('hidden');
  document.getElementById('sessionBanner').classList.remove('show');
  document.getElementById('authInput').value = '';
}

// ===== SECURITY: Session Timeout =====
function startSessionTimer() {
  resetSessionTimer();
  
  // Track user activity
  ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
    document.addEventListener(event, resetSessionTimer, { passive: true });
  });
}

function resetSessionTimer() {
  // Clear existing timers
  if (sessionTimer) clearTimeout(sessionTimer);
  if (warningTimer) clearTimeout(warningTimer);
  
  // Hide warning banner
  document.getElementById('sessionBanner').classList.remove('show');
  
  // Update session expiry
  const sessionData = {
    authenticated: true,
    expiry: Date.now() + SECURITY.SESSION_TIMEOUT
  };
  sessionStorage.setItem(AUTH_KEY, JSON.stringify(sessionData));
  
  // Set warning timer (5 min before timeout)
  warningTimer = setTimeout(() => {
    document.getElementById('sessionBanner').classList.add('show');
  }, SECURITY.SESSION_TIMEOUT - SECURITY.SESSION_WARNING);
  
  // Set logout timer
  sessionTimer = setTimeout(() => {
    showToast('Session expired', 'error');
    logout();
  }, SECURITY.SESSION_TIMEOUT);
}

// ===== API =====
async function getAuthToken() {
  if (jwtToken && tokenExpiry && Date.now() < tokenExpiry) return jwtToken;
  
  const res = await fetch(`${CONFIG.AUTH_BASE}/auth/token?token=${CONFIG.API_KEY}`, {
    headers: { 'Authorization': `Bearer ${CONFIG.API_KEY}` }
  });
  
  if (!res.ok) throw new Error(`Auth failed: ${res.status}`);
  const data = await res.json();
  jwtToken = data.token;
  tokenExpiry = Date.now() + 50 * 60 * 1000;
  return jwtToken;
}

async function api(endpoint, options = {}) {
  const res = await fetch(`${CONFIG.API_BASE}${endpoint}`, {
    headers: { 'Authorization': `Bearer ${CONFIG.API_KEY}`, 'Content-Type': 'application/json', ...options.headers },
    ...options
  });
  if (!res.ok) throw new Error(`API ${res.status}`);
  if (res.status === 204) return null;
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

async function apiAuth(endpoint, options = {}) {
  const token = await getAuthToken();
  const res = await fetch(`${CONFIG.API_BASE}${endpoint}`, {
    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', ...options.headers },
    ...options
  });
  if (!res.ok) throw new Error(`API ${res.status}`);
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  // Check HTTPS
  checkHTTPS();
  
  // Handle Enter key on password input
  document.getElementById('authInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') attemptLogin();
  });
  
  // Check if already authenticated
  if (checkAuth()) {
    initializeApp();
  }
});

async function initializeApp() {
  setupDragDrop();
  setupFileInput();
  setupHorizontalScroll();
  setupClickOutside();
  
  try {
    setLoadingText('Loading collections...');
    await loadCollections();
    setLoadingText('Loading documents...');
    await loadDocuments();
    setStatus(true);
    renderCollections();
  } catch (err) {
    setStatus(false);
    showToast('Failed to connect', 'error');
  }
  
  hideLoading();
}

function setLoadingText(t) { document.getElementById('loadingText').textContent = t; }
function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
function setStatus(ok) {
  document.getElementById('statusDot').classList.toggle('disconnected', !ok);
  document.getElementById('statusText').textContent = ok ? 'Connected' : 'Disconnected';
}

// ===== DATA LOADING =====
async function loadCollections() {
  const data = await api('/collections/search', {
    method: 'POST',
    body: JSON.stringify({ dynamic: false, status: 'active', limit: 100 })
  });
  collections = data || [];
}

async function loadDocuments() {
  const data = await api('/objects?limit=1000&offset=0');
  allDocuments = (Array.isArray(data) ? data : data?.objects || [])
    .filter(o => o.content?.source)
    .map(o => ({
      id: o.id,
      name: o.name || 'Untitled',
      type: o.properties?.document_type || 'Document',
      date: formatDate(o.created_at),
      source: o.content?.source
    }));
}

async function loadCollectionMembers(colId) {
  if (collectionMembers[colId]) return collectionMembers[colId];
  const members = await api(`/collections/${colId}/members?limit=1000`);
  collectionMembers[colId] = (members || []).map(m => m.id || m);
  return collectionMembers[colId];
}

function formatDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

async function refreshData() {
  showToast('Refreshing...');
  collectionMembers = {};
  await loadCollections();
  await loadDocuments();
  renderCollections();
  if (selectedCollection) {
    await selectCollection(selectedCollection.id);
  }
  showToast('Data refreshed', 'success');
}

// ===== RENDERING =====
function renderCollections() {
  const container = document.getElementById('collectionsScroll');
  
  const sorted = [...collections].sort((a, b) => {
    const aPinned = pinnedCollections.has(a.id);
    const bPinned = pinnedCollections.has(b.id);
    const aComplete = completedCollections.has(a.id);
    const bComplete = completedCollections.has(b.id);
    
    if (aPinned && !bPinned) return -1;
    if (!aPinned && bPinned) return 1;
    if (!aComplete && bComplete) return -1;
    if (aComplete && !bComplete) return 1;
    return 0;
  });
  
  let html = `
    <div class="collection-card new" onclick="createCollection()">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
      <span style="font-size:12px;font-weight:500">New Collection</span>
    </div>
  `;
  
  sorted.forEach(col => {
    const isActive = selectedCollection?.id === col.id;
    const isPinned = pinnedCollections.has(col.id);
    const isComplete = completedCollections.has(col.id);
    const isSettingUp = settingUpCollections.has(col.id);
    const jobs = processingJobs.filter(j => j.collectionId === col.id && j.status === 'processing');
    
    html += `
      <div class="collection-card ${isActive ? 'active' : ''} ${isComplete ? 'complete' : ''} ${isSettingUp ? 'setting-up' : ''}" 
           onclick="${isSettingUp ? '' : `selectCollection('${col.id}')`}" data-id="${col.id}">
        <button class="card-pin ${isPinned ? 'active' : ''}" onclick="event.stopPropagation();togglePin('${col.id}')" title="Pin">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="${isPinned ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
        </button>
        <button class="card-menu-btn" onclick="event.stopPropagation();openCardMenu('${col.id}', event)" title="More">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
        </button>
        <div class="card-header">
          <div class="card-icon">
            ${isSettingUp 
              ? '<div class="card-icon-spinner"></div>'
              : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>'
            }
          </div>
          <div class="card-name" title="${col.name}">${col.name}</div>
        </div>
        <div class="card-meta">
          <span class="card-status ${isComplete ? 'complete' : 'active'}">${isComplete ? 'Complete' : 'Active'}</span>
        </div>
        ${isSettingUp ? '<span class="card-badge setting-up">Setting up...</span>' : ''}
        ${!isSettingUp && jobs.length > 0 ? `<span class="card-badge processing">${jobs.length} processing</span>` : ''}
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function renderLibrary() {
  const container = document.getElementById('libraryList');
  const search = document.getElementById('librarySearch').value.toLowerCase();
  
  if (!selectedCollection) {
    container.innerHTML = '<div class="library-empty">Select a collection to view documents</div>';
    document.getElementById('libraryTitle').textContent = 'Collection Library';
    return;
  }
  
  document.getElementById('libraryTitle').textContent = `${selectedCollection.name} Library`;
  
  const memberIds = collectionMembers[selectedCollection.id] || [];
  const docs = allDocuments.filter(d => memberIds.includes(d.id));
  
  const filtered = docs.filter(d => {
    if (!search) return true;
    return d.name.toLowerCase().includes(search) || d.type.toLowerCase().includes(search);
  });
  
  if (filtered.length === 0) {
    container.innerHTML = `<div class="library-empty">${search ? 'No matching documents' : 'No documents in this collection'}</div>`;
    return;
  }
  
  container.innerHTML = filtered.map(doc => `
    <div class="library-item ${doc.processing ? 'processing' : ''}" ${doc.processing ? '' : `onclick="viewDocument('${doc.id}')"`}>
      <div class="library-item-icon">
        ${doc.processing 
          ? '<div class="library-item-spinner"></div>'
          : '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>'
        }
      </div>
      <div class="library-item-info">
        <div class="library-item-name" title="${doc.name}">${doc.name}</div>
        <div class="library-item-meta">${doc.date} Â· ${doc.type}</div>
      </div>
      ${doc.processing ? '' : `
        <button class="library-item-delete" onclick="event.stopPropagation(); deleteDocument('${doc.id}')" title="Remove from collection">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      `}
    </div>
  `).join('');
}

// ===== COLLECTION ACTIONS =====
async function selectCollection(colId) {
  selectedCollection = collections.find(c => c.id === colId);
  renderCollections();
  updateUploadTarget();
  
  document.getElementById('collectionTitle').innerHTML = `
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
    ${selectedCollection.name}
  `;
  
  await loadCollectionMembers(colId);
  renderLibrary();
  await loadChecklist(colId);
}

function updateUploadTarget() {
  const targetEl = document.getElementById('uploadTarget');
  const nameEl = document.getElementById('uploadTargetName');
  const addBtn = document.getElementById('libraryAddBtn');
  
  if (selectedCollection) {
    nameEl.textContent = selectedCollection.name;
    targetEl.classList.remove('no-collection');
    addBtn.disabled = false;
  } else {
    nameEl.textContent = 'New Collection (auto-create)';
    targetEl.classList.add('no-collection');
    addBtn.disabled = true;
  }
}

async function loadChecklist(colId) {
  const area = document.getElementById('checklistArea');
  area.innerHTML = `<div class="viewer-loading"><div class="loading-spinner" style="width:24px;height:24px;border-width:2px"></div><span>Loading checklist...</span></div>`;
  
  try {
    const memberIds = collectionMembers[colId] || [];
    
    let checklistDoc = null;
    for (const id of memberIds) {
      const doc = allDocuments.find(d => d.id === id);
      if (doc && (doc.name.toLowerCase().includes('checklist') || doc.source?.endsWith('.md'))) {
        checklistDoc = doc;
        break;
      }
    }
    
    if (checklistDoc) {
      const content = await fetchDocContent(checklistDoc.source);
      area.innerHTML = `<div class="checklist-content">${marked.parse(content)}</div>`;
      styleStatusCells(area);
    } else {
      area.innerHTML = `
        <div class="checklist-empty">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          <p>No checklist found</p>
          <small>Upload documents to auto-generate a checklist</small>
        </div>
      `;
    }
  } catch (err) {
    area.innerHTML = `<div class="checklist-empty"><p style="color:#dc3545">Failed to load checklist</p></div>`;
  }
}

function styleStatusCells(container) {
  container.querySelectorAll('td').forEach(td => {
    const text = td.textContent.trim().toLowerCase();
    if (text === 'complete') { td.style.color = 'var(--success)'; td.style.fontWeight = '600'; }
    else if (text === 'incomplete') { td.style.color = '#dc3545'; }
    else if (text === 'partial') { td.style.color = 'var(--warning)'; }
  });
}

async function fetchDocContent(source) {
  const { url } = await api('/objects/download-url', {
    method: 'POST',
    body: JSON.stringify({ file: source, format: 'original' })
  });
  const res = await fetch(url);
  return await res.text();
}

async function createCollection() {
  const name = prompt('Enter collection name:');
  if (!name?.trim()) return;
  
  let newCol = null;
  
  try {
    // Step 1: Create the collection
    newCol = await apiAuth('/collections', {
      method: 'POST',
      body: JSON.stringify({ name: name.trim(), description: '', dynamic: false })
    });
    
    if (newCol?.id) {
      collections.unshift(newCol);
      settingUpCollections.add(newCol.id); // Mark as setting up
    } else {
      await loadCollections();
      newCol = collections.find(c => c.name === name.trim());
      if (newCol) settingUpCollections.add(newCol.id);
    }
    
    renderCollections();
    showToast(`Creating "${name}"...`, 'info');
    
    // Step 2: Call PopulateNewCollection agent to seed with blank templates
    if (newCol?.id) {
      await populateNewCollection(newCol.id, name.trim());
    }
    
  } catch (err) {
    if (newCol?.id) settingUpCollections.delete(newCol.id);
    renderCollections();
    showToast('Failed to create collection', 'error');
  }
}

async function populateNewCollection(collectionId, collectionName) {
  try {
    // Get JWT for agent call
    const jwtRes = await fetch(`${CONFIG.AUTH_BASE}/auth/token?token=${CONFIG.API_KEY}`, {
      method: 'GET',
      headers: { 'Authorization': `Bearer ${CONFIG.API_KEY}` }
    });
    if (!jwtRes.ok) throw new Error(`JWT failed: ${jwtRes.status}`);
    const jwt = (await jwtRes.json()).token;
    
    // Call the PopulateNewCollection agent
    const agentRes = await fetch(`${CONFIG.API_BASE}/execute/async`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${jwt}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        type: 'conversation',
        interaction: CONFIG.POPULATE_INTERACTION,
        data: { 
          collection: collectionId,
          checklist: CONFIG.BLANK_CHECKLIST_ID,
          documents: CONFIG.BLANK_PROGRESS_ID
        },
        config: {
          environment: '681915c6a01fb262a410c161',
          model: 'publishers/anthropic/models/claude-sonnet-4'
        },
        interactive: true,
        max_iterations: 50
      })
    });
    
    if (!agentRes.ok) {
      const errText = await agentRes.text();
      throw new Error(`Populate agent failed: ${agentRes.status} - ${errText}`);
    }
    
    // Wait a moment for agent to complete, then refresh
    await new Promise(resolve => setTimeout(resolve, 3000));
    
    // Refresh collection data
    delete collectionMembers[collectionId]; // Clear cached members
    await loadDocuments();
    await loadCollectionMembers(collectionId);
    
    // Mark setup complete
    settingUpCollections.delete(collectionId);
    renderCollections();
    
    // Auto-select the new collection
    const col = collections.find(c => c.id === collectionId);
    if (col) {
      await selectCollection(collectionId);
    }
    
    showToast(`"${collectionName}" ready`, 'success');
    
  } catch (err) {
    console.error('Populate collection error:', err);
    settingUpCollections.delete(collectionId);
    renderCollections();
    showToast('Collection created (templates may need manual setup)', 'warning');
  }
}

function togglePin(colId) {
  if (pinnedCollections.has(colId)) {
    pinnedCollections.delete(colId);
  } else {
    pinnedCollections.add(colId);
  }
  savePinned();
  renderCollections();
}

// ===== CARD MENU =====
function openCardMenu(colId, event) {
  const dropdown = document.getElementById('cardDropdown');
  const rect = event.target.getBoundingClientRect();
  
  menuTargetCollection = collections.find(c => c.id === colId);
  
  const isComplete = completedCollections.has(colId);
  document.getElementById('completeMenuText').textContent = isComplete ? 'Reopen' : 'Mark Complete';
  
  dropdown.style.top = (rect.bottom + 4) + 'px';
  dropdown.style.left = (rect.left - 100) + 'px';
  dropdown.classList.add('open');
}

function closeCardMenu() {
  document.getElementById('cardDropdown').classList.remove('open');
  menuTargetCollection = null;
}

async function renameCollection() {
  if (!menuTargetCollection) return;
  const targetCol = menuTargetCollection;
  closeCardMenu();
  
  const newName = prompt('Enter new name:', targetCol.name);
  if (!newName?.trim() || newName === targetCol.name) return;
  
  try {
    await apiAuth(`/collections/${targetCol.id}`, {
      method: 'PUT',
      body: JSON.stringify({ name: newName.trim() })
    });
    
    targetCol.name = newName.trim();
    renderCollections();
    
    if (selectedCollection?.id === targetCol.id) {
      document.getElementById('collectionTitle').innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
        ${newName.trim()}
      `;
      renderLibrary();
    }
    
    showToast('Renamed', 'success');
  } catch (err) {
    showToast('Failed to rename', 'error');
  }
}

function toggleCompleteCollection() {
  if (!menuTargetCollection) return;
  const colId = menuTargetCollection.id;
  closeCardMenu();
  
  if (completedCollections.has(colId)) {
    completedCollections.delete(colId);
    showToast('Reopened');
  } else {
    completedCollections.add(colId);
    pinnedCollections.delete(colId);
    savePinned();
    showToast('Marked complete', 'success');
  }
  saveCompleted();
  renderCollections();
}

async function deleteCollection() {
  if (!menuTargetCollection) return;
  const targetCol = menuTargetCollection;
  closeCardMenu();
  
  if (!confirm(`Delete "${targetCol.name}"? This cannot be undone.`)) return;
  
  try {
    await api(`/collections/${targetCol.id}`, { method: 'DELETE' });
    
    collections = collections.filter(c => c.id !== targetCol.id);
    pinnedCollections.delete(targetCol.id);
    completedCollections.delete(targetCol.id);
    savePinned();
    saveCompleted();
    
    if (selectedCollection?.id === targetCol.id) {
      selectedCollection = null;
      updateUploadTarget();
      document.getElementById('collectionTitle').innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
        Select a Collection
      `;
      document.getElementById('checklistArea').innerHTML = `
        <div class="checklist-empty">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          <p>Select a collection to view its checklist</p>
        </div>
      `;
      renderLibrary();
    }
    
    renderCollections();
    showToast('Deleted', 'success');
  } catch (err) {
    showToast('Failed to delete', 'error');
  }
}

// ===== DOCUMENT VIEWER =====
async function viewDocument(docId) {
  const doc = allDocuments.find(d => d.id === docId);
  if (!doc) return;
  
  const dialog = document.getElementById('docViewer');
  document.getElementById('viewerTitle').textContent = doc.name;
  document.getElementById('viewerBody').innerHTML = `<div class="viewer-loading"><div class="loading-spinner" style="width:24px;height:24px;border-width:2px"></div><span>Loading...</span></div>`;
  
  dialog.showModal();
  
  try {
    const content = await fetchDocContent(doc.source);
    document.getElementById('viewerBody').innerHTML = marked.parse(content);
  } catch (err) {
    document.getElementById('viewerBody').innerHTML = `<p style="color:#dc3545;text-align:center;padding:40px">Failed to load document</p>`;
  }
}

function closeViewer() {
  document.getElementById('docViewer').close();
}

// ===== DOCUMENT MANAGEMENT =====
async function deleteDocument(docId) {
  const doc = allDocuments.find(d => d.id === docId);
  if (!doc) return;
  
  if (!confirm(`Remove "${doc.name}" from this collection?`)) return;
  
  try {
    if (selectedCollection) {
      await api(`/collections/${selectedCollection.id}/members/${docId}`, {
        method: 'DELETE'
      });
      
      if (collectionMembers[selectedCollection.id]) {
        collectionMembers[selectedCollection.id] = collectionMembers[selectedCollection.id].filter(id => id !== docId);
      }
    }
    
    renderLibrary();
    showToast(`Removed "${doc.name}"`, 'success');
    
  } catch (err) {
    showToast('Failed to remove document', 'error');
  }
}

// ===== DOCUMENT PICKER =====
function openDocumentPicker() {
  if (!selectedCollection) return;
  
  const dialog = document.getElementById('docPicker');
  document.getElementById('pickerSearch').value = '';
  renderDocumentPicker();
  dialog.showModal();
}

function closeDocumentPicker() {
  document.getElementById('docPicker').close();
}

function renderDocumentPicker() {
  const container = document.getElementById('pickerBody');
  const search = document.getElementById('pickerSearch').value.toLowerCase();
  
  const memberIds = selectedCollection ? (collectionMembers[selectedCollection.id] || []) : [];
  
  const filtered = allDocuments.filter(d => {
    if (!search) return true;
    return d.name.toLowerCase().includes(search) || d.type.toLowerCase().includes(search);
  });
  
  if (filtered.length === 0) {
    container.innerHTML = '<div class="picker-empty">No documents found</div>';
    return;
  }
  
  container.innerHTML = filtered.map(doc => {
    const inCollection = memberIds.includes(doc.id);
    return `
      <div class="picker-item">
        <div class="picker-item-icon">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        </div>
        <div class="picker-item-info">
          <div class="picker-item-name" title="${doc.name}">${doc.name}</div>
          <div class="picker-item-meta">${doc.date} Â· ${doc.type}</div>
        </div>
        <div class="picker-item-action">
          ${inCollection 
            ? '<span class="picker-added">Added</span>'
            : `<button class="picker-add-btn" onclick="addDocumentToCollection('${doc.id}')">Add</button>`
          }
        </div>
      </div>
    `;
  }).join('');
}

async function addDocumentToCollection(docId) {
  if (!selectedCollection) return;
  
  try {
    await api(`/collections/${selectedCollection.id}/members`, {
      method: 'POST',
      body: JSON.stringify({ id: docId })
    });
    
    if (!collectionMembers[selectedCollection.id]) {
      collectionMembers[selectedCollection.id] = [];
    }
    collectionMembers[selectedCollection.id].push(docId);
    
    renderDocumentPicker();
    renderLibrary();
    
    const doc = allDocuments.find(d => d.id === docId);
    showToast(`Added "${doc?.name || 'document'}"`, 'success');
    
  } catch (err) {
    showToast('Failed to add document', 'error');
  }
}

// ===== FILE UPLOAD =====
function setupDragDrop() {
  const zone = document.getElementById('uploadZone');
  
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
    zone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
  });
  
  ['dragenter', 'dragover'].forEach(e => zone.addEventListener(e, () => zone.classList.add('dragover')));
  ['dragleave', 'drop'].forEach(e => zone.addEventListener(e, () => zone.classList.remove('dragover')));
  
  zone.addEventListener('drop', e => {
    const files = Array.from(e.dataTransfer.files);
    if (files.length) handleFiles(files);
  });
}

function setupFileInput() {
  document.getElementById('fileInput').addEventListener('change', e => {
    const files = Array.from(e.target.files);
    if (files.length) handleFiles(files);
    e.target.value = '';
  });
}

async function handleFiles(files) {
  for (const file of files) {
    // SECURITY: Validate file before processing
    const errors = validateFile(file);
    if (errors.length > 0) {
      showToast(`${file.name}: ${errors.join(', ')}`, 'error');
      continue;
    }
    await processFile(file);
  }
}

async function processFile(file) {
  const queueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  // SECURITY: Sanitize filename
  const safeName = sanitizeFilename(file.name);
  addToQueue(queueId, safeName);
  
  const mimeType = file.type || getMimeType(safeName);
  
  try {
    updateQueueStatus(queueId, 'Authenticating...', 'processing');
    const jwtRes = await fetch(`${CONFIG.AUTH_BASE}/auth/token?token=${CONFIG.API_KEY}`, {
      method: 'GET',
      headers: { 'Authorization': `Bearer ${CONFIG.API_KEY}` }
    });
    if (!jwtRes.ok) throw new Error(`JWT failed: ${jwtRes.status}`);
    const jwt = (await jwtRes.json()).token;

    updateQueueStatus(queueId, 'Getting upload URL...', 'processing');
    const uploadRes = await fetch(`${CONFIG.API_BASE}/objects/upload-url`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${CONFIG.API_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ name: safeName, mime_type: mimeType })
    });
    if (!uploadRes.ok) throw new Error(`Upload URL failed: ${uploadRes.status}`);
    const uploadData = await uploadRes.json();

    updateQueueStatus(queueId, 'Uploading file...', 'processing');
    const putRes = await fetch(uploadData.url, {
      method: 'PUT',
      headers: { 'Content-Type': mimeType },
      body: file
    });
    if (!putRes.ok) throw new Error(`GCS upload failed: ${putRes.status}`);

    updateQueueStatus(queueId, 'Creating object...', 'processing');
    const createRes = await fetch(`${CONFIG.API_BASE}/objects`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${jwt}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        name: safeName,
        content: {
          source: uploadData.id,
          type: mimeType,
          name: safeName
        }
      })
    });
    if (!createRes.ok) throw new Error(`Create object failed: ${createRes.status}`);
    const obj = await createRes.json();

    const newDoc = {
      id: obj.id,
      name: safeName,
      type: 'Processing...',
      date: formatDate(new Date().toISOString()),
      source: uploadData.id,
      processing: true
    };
    allDocuments.push(newDoc);
    
    if (selectedCollection) {
      if (!collectionMembers[selectedCollection.id]) {
        collectionMembers[selectedCollection.id] = [];
      }
      collectionMembers[selectedCollection.id].push(obj.id);
      renderLibrary();
    }

    updateQueueStatus(queueId, 'Processing...', 'processing');
    
    const targetCollection = selectedCollection ? selectedCollection.id : 'NEW';
    
    const agentRes = await fetch(`${CONFIG.API_BASE}/execute/async`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${jwt}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        type: 'conversation',
        interaction: CONFIG.INTERACTION,
        data: { 
          task: obj.id,
          target_collection: targetCollection
        },
        config: {
          environment: '681915c6a01fb262a410c161',
          model: 'publishers/anthropic/models/claude-sonnet-4'
        },
        interactive: true,
        max_iterations: 100
      })
    });
    if (!agentRes.ok) {
      const errText = await agentRes.text();
      throw new Error(`Agent failed: ${agentRes.status} - ${errText}`);
    }

    const docIndex = allDocuments.findIndex(d => d.id === obj.id);
    if (docIndex !== -1) {
      allDocuments[docIndex].processing = false;
      allDocuments[docIndex].type = 'Document';
      renderLibrary();
    }

    updateQueueStatus(queueId, 'Complete', 'complete');
    const targetName = selectedCollection ? selectedCollection.name : 'New Collection';
    showToast(`${safeName} â†’ ${targetName}`, 'success');

  } catch (err) {
    updateQueueStatus(queueId, err.message, 'error');
    showToast(`Failed: ${file.name}`, 'error');
  }
}

function getMimeType(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const types = {
    pdf: 'application/pdf',
    docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    doc: 'application/msword',
    txt: 'text/plain',
    md: 'text/markdown',
    png: 'image/png',
    jpg: 'image/jpeg',
    jpeg: 'image/jpeg',
    xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    xls: 'application/vnd.ms-excel',
    csv: 'text/csv'
  };
  return types[ext] || 'application/octet-stream';
}

// ===== QUEUE UI =====
function addToQueue(id, name) {
  const queue = document.getElementById('uploadQueue');
  const item = document.createElement('div');
  item.className = 'queue-item';
  item.id = `queue-${id}`;
  item.innerHTML = `
    <div class="queue-item-icon">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
    </div>
    <div class="queue-item-info">
      <div class="queue-item-name">${name}</div>
      <div class="queue-item-status processing" id="status-${id}">Preparing...</div>
    </div>
    <div class="queue-item-spinner" id="spinner-${id}"></div>
  `;
  queue.appendChild(item);
}

function updateQueueStatus(id, status, state = 'processing') {
  const statusEl = document.getElementById(`status-${id}`);
  const spinnerEl = document.getElementById(`spinner-${id}`);
  
  if (statusEl) {
    statusEl.textContent = status;
    statusEl.className = `queue-item-status ${state}`;
  }
  
  if (spinnerEl) {
    if (state === 'complete') {
      spinnerEl.outerHTML = `<svg class="queue-item-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>`;
    } else if (state === 'error') {
      spinnerEl.outerHTML = `<svg style="color:#dc3545" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`;
    }
  }
}

// ===== UTILITY =====
function setupHorizontalScroll() {
  const scroll = document.getElementById('collectionsScroll');
  scroll.addEventListener('wheel', e => {
    if (e.deltaY !== 0) {
      e.preventDefault();
      scroll.scrollLeft += e.deltaY;
    }
  }, { passive: false });
}

function setupClickOutside() {
  document.addEventListener('click', e => {
    if (!e.target.closest('.card-menu-btn') && !e.target.closest('.card-dropdown')) {
      closeCardMenu();
    }
  });
}

function showToast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icons = {
    success: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
    error: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
    warning: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    info: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
  };
  
  toast.innerHTML = `${icons[type] || icons.info}<span>${msg}</span>`;
  container.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
}
</script>
</body>
</html>
